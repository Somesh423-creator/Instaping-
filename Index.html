<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Invoice Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        :root {
            --primary-color: #007bff; /* Sky blue */
            --background-color: #f0f8ff; /* Light sky blue */
            --text-color: #333;
            --light-text-color: #666;
            --border-color: #ddd;
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.12);
            --gradient-start: #6dd5ed;
            --gradient-end: #2193b0;
        }

        /* Dark Mode variables */
        body.dark-mode {
            --background-color: #1a202c;
            --text-color: #f7fafc;
            --light-text-color: #a0aec0;
            --border-color: #4a5568;
            --primary-color: #4299e1;
            --shadow-light: rgba(0, 0, 0, 0.3);
            --shadow-medium: rgba(0, 0, 0, 0.5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 450px; /* Mobile-first approach */
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 10px var(--shadow-light);
            text-align: center;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        @media (min-width: 768px) {
            .container {
                max-width: 700px;
            }
        }

        header {
            padding: 20px 0;
            text-align: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            margin-bottom: 15px;
            border-radius: 50%;
            background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
            display: inline-flex;
            justify-content: center;
            align-items: center;
            font-size: 40px;
            font-weight: 700;
            color: white;
            box-shadow: 0 4px 8px var(--shadow-medium);
        }

        h1 {
            font-size: 2.5em;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        p {
            font-size: 1.1em;
            color: var(--light-text-color);
            margin-bottom: 20px;
        }

        .btn {
            background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-shadow: 0 4px 8px var(--shadow-medium);
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px var(--shadow-medium);
        }

        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-color);
        }

        .form-group input[type="email"],
        .form-group input[type="password"],
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"] {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            background-color: var(--background-color); /* Matches body for consistency */
            color: var(--text-color);
        }

        .form-group input[type="email"]:focus,
        .form-group input[type="password"]:focus,
        .form-group input[type="text"]:focus,
        .form-group input[type="number"]:focus,
        .form-group input[type="date"]:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.2);
            outline: none;
        }

        .auth-form {
            max-width: 400px;
            margin: 0 auto;
            padding: 25px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 10px var(--shadow-light);
            text-align: center;
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .auth-form h2 {
            margin-bottom: 20px;
            color: var(--primary-color);
            font-size: 1.8em;
        }

        .auth-form .btn {
            width: 100%;
            margin-top: 15px;
        }

        .auth-form .toggle-auth {
            margin-top: 20px;
            font-size: 0.9em;
            color: var(--light-text-color);
        }

        .auth-form .toggle-auth a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
        }

        .google-signin-btn {
            background-color: #db4437; /* Google Red */
            margin-top: 15px;
        }
        .google-signin-btn:hover {
            background-color: #c0362c;
        }

        /* Dashboard styles */
        .dashboard-container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 4px 10px var(--shadow-light);
            transition: background-color 0.3s ease, box-shadow 0.3s ease;
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .user-info h2 {
            color: var(--primary-color);
            font-size: 1.5em;
        }

        .logout-btn {
            background-color: #dc3545; /* Red */
            padding: 8px 15px;
            font-size: 0.9em;
        }

        .logout-btn:hover {
            background-color: #c82333;
        }

        .plan-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .plan-card {
            background-color: var(--background-color);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px var(--shadow-light);
            border: 1px solid var(--border-color);
            text-align: left;
            transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.3s ease;
        }

        .plan-card.current-plan {
            border-color: var(--primary-color);
            box-shadow: 0 4px 10px rgba(0, 123, 255, 0.2);
            transform: translateY(-5px);
            background-color: #e6f2ff; /* Lighter shade of primary for current */
        }

        .dark-mode .plan-card.current-plan {
            background-color: #2b3b51;
        }

        .plan-card h3 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 1.3em;
        }

        .plan-card ul {
            list-style: none;
            padding: 0;
            margin-top: 10px;
            font-size: 0.95em;
            color: var(--light-text-color);
        }

        .plan-card ul li {
            margin-bottom: 5px;
        }

        .invoice-form-section h2 {
            color: var(--primary-color);
            margin-bottom: 20px;
            text-align: center;
        }

        .invoice-form {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            max-width: 600px;
            margin: 0 auto;
        }

        @media (min-width: 600px) {
            .invoice-form {
                grid-template-columns: 1fr 1fr;
            }
        }

        .invoice-form .form-group {
            grid-column: span 1;
        }

        .invoice-form .full-width {
            grid-column: 1 / -1;
        }

        .download-btn {
            background-color: #28a745; /* Green */
            margin-top: 20px;
            display: none; /* Hidden by default */
        }
        .download-btn:hover {
            background-color: #218838;
        }

        .message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.9em;
            text-align: center;
        }

        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .dark-mode .message.success {
            background-color: #285a3d;
            color: #d4edda;
            border: 1px solid #3c7d54;
        }

        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .dark-mode .message.error {
            background-color: #721c24;
            color: #f8d7da;
            border: 1px solid #9c2a37;
        }

        footer {
            margin-top: auto;
            padding: 20px;
            text-align: center;
            font-size: 0.9em;
            color: var(--light-text-color);
            background-color: #f0f0f0;
            border-top: 1px solid var(--border-color);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .dark-mode footer {
            background-color: #2d3748;
            border-top-color: #4a5568;
        }

        /* Animated transitions */
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.6s ease-out forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Dark mode toggle */
        .dark-mode-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            cursor: pointer;
            width: 40px;
            height: 20px;
            background-color: var(--border-color);
            border-radius: 10px;
            display: flex;
            align-items: center;
            padding: 2px;
            transition: background-color 0.3s ease;
        }

        .dark-mode-toggle .slider {
            width: 16px;
            height: 16px;
            background-color: #fff;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        body.dark-mode .dark-mode-toggle {
            background-color: var(--primary-color);
        }

        body.dark-mode .dark-mode-toggle .slider {
            transform: translateX(20px);
        }
    </style>
</head>
<body>

    <div class="dark-mode-toggle" id="darkModeToggle">
        <div class="slider"></div>
    </div>

    <div id="intro-screen" class="container fade-in">
        <header>
            <div class="logo">AI</div>
            <h1>AI Invoice Generator</h1>
            <p>Generate invoices globally in seconds</p>
            <button class="btn" id="getStartedBtn">Let’s Get Started</button>
        </header>
    </div>

    <div id="auth-screen" class="container auth-form" style="display: none;">
        <h2 id="auth-title">Sign Up</h2>
        <form id="signup-form">
            <div class="form-group">
                <label for="signup-email">Email</label>
                <input type="email" id="signup-email" placeholder="your@example.com" required>
            </div>
            <div class="form-group">
                <label for="signup-password">Password</label>
                <input type="password" id="signup-password" placeholder="min 6 characters" required>
            </div>
            <button type="submit" class="btn">Sign Up</button>
            <div class="message" id="signup-message" style="display: none;"></div>
        </form>

        <form id="signin-form" style="display: none;">
            <div class="form-group">
                <label for="signin-email">Email</label>
                <input type="email" id="signin-email" placeholder="your@example.com" required>
            </div>
            <div class="form-group">
                <label for="signin-password">Password</label>
                <input type="password" id="signin-password" placeholder="your password" required>
            </div>
            <button type="submit" class="btn">Sign In</button>
            <div class="message" id="signin-message" style="display: none;"></div>
        </form>

        <button class="btn google-signin-btn" id="google-signin-btn">Sign In with Google</button>

        <div class="toggle-auth">
            <span id="toggle-auth-text">Already have an account? </span>
            <a href="#" id="toggle-auth-link">Sign In</a>
        </div>
    </div>

    <div id="dashboard-screen" class="dashboard-container" style="display: none;">
        <div class="user-info">
            <h2>Welcome, <span id="user-email"></span>!</h2>
            <button class="btn logout-btn" id="logoutBtn">Logout</button>
        </div>

        <h3>Your Plan Details</h3>
        <div class="plan-details">
            <div class="plan-card" id="free-plan-card">
                <h3>Free Plan</h3>
                <ul>
                    <li><strong>Duration:</strong> Monthly</li>
                    <li><strong>Invoice Limit:</strong> 5 invoices/month</li>
                    <li><strong>Expiry:</strong> Never (resets monthly)</li>
                </ul>
            </div>
            <div class="plan-card" id="pro-plan-card">
                <h3>Pro Plan</h3>
                <ul>
                    <li><strong>Duration:</strong> Monthly/Yearly</li>
                    <li><strong>Invoice Limit:</strong> 50 invoices/month</li>
                    <li><strong>Expiry:</strong> <span id="pro-expiry-date">N/A</span></li>
                </ul>
            </div>
            <div class="plan-card" id="advance-plan-card">
                <h3>Advance Plan</h3>
                <ul>
                    <li><strong>Duration:</strong> Monthly/Yearly</li>
                    <li><strong>Invoice Limit:</strong> Unlimited</li>
                    <li><strong>Expiry:</strong> <span id="advance-expiry-date">N/A</span></li>
                </ul>
            </div>
        </div>

        <hr>

        <div class="invoice-form-section">
            <h2>Generate New Invoice</h2>
            <form id="invoice-generator-form" class="invoice-form">
                <div class="form-group full-width">
                    <label for="client-name">Client Name</label>
                    <input type="text" id="client-name" required>
                </div>
                <div class="form-group full-width">
                    <label for="client-email">Client Email</label>
                    <input type="email" id="client-email" required>
                </div>
                <div class="form-group full-width">
                    <label for="item-description">Item Description</label>
                    <input type="text" id="item-description" required>
                </div>
                <div class="form-group">
                    <label for="amount">Amount ($)</label>
                    <input type="number" id="amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="due-date">Due Date</label>
                    <input type="date" id="due-date" required>
                </div>
                <div class="form-group full-width">
                    <button type="submit" class="btn full-width">Generate Invoice</button>
                </div>
            </form>
            <button class="btn download-btn full-width" id="downloadPdfBtn" style="display: none;">Download Invoice PDF</button>
            <div class="message" id="invoice-message" style="display: none;"></div>
        </div>
    </div>

    <footer>
        <p>&copy; <span id="current-year"></span> AI Invoice Generator. All rights reserved.</p>
        <p>Made with ❤️ for freelancers</p>
    </footer>

    <script>
        // Supabase Initialization
        const SUPABASE_URL = 'https://gjpzbbpgqzqbmoomygjy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqcHpiYnBncXpxYm1vb215Z2p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDcyMzUsImV4cCI6MjA2ODY4MzIzNX0.0EbdKvDPrHZiRWWFZkTFgV2O4l6xHc3arz0BwCmjA98';
        const supabase = Supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM Elements
        const introScreen = document.getElementById('intro-screen');
        const authScreen = document.getElementById('auth-screen');
        const dashboardScreen = document.getElementById('dashboard-screen');

        const getStartedBtn = document.getElementById('getStartedBtn');

        const authTitle = document.getElementById('auth-title');
        const signupForm = document.getElementById('signup-form');
        const signinForm = document.getElementById('signin-form');
        const toggleAuthLink = document.getElementById('toggle-auth-link');
        const toggleAuthText = document.getElementById('toggle-auth-text');
        const googleSigninBtn = document.getElementById('google-signin-btn');

        const signupEmail = document.getElementById('signup-email');
        const signupPassword = document.getElementById('signup-password');
        const signinEmail = document.getElementById('signin-email');
        const signinPassword = document.getElementById('signin-password');

        const signupMessage = document.getElementById('signup-message');
        const signinMessage = document.getElementById('signin-message');
        const invoiceMessage = document.getElementById('invoice-message');

        const userEmailSpan = document.getElementById('user-email');
        const logoutBtn = document.getElementById('logoutBtn');

        const freePlanCard = document.getElementById('free-plan-card');
        const proPlanCard = document.getElementById('pro-plan-card');
        const advancePlanCard = document.getElementById('advance-plan-card');
        const proExpiryDateSpan = document.getElementById('pro-expiry-date');
        const advanceExpiryDateSpan = document.getElementById('advance-expiry-date');

        const invoiceGeneratorForm = document.getElementById('invoice-generator-form');
        const clientNameInput = document.getElementById('client-name');
        const clientEmailInput = document.getElementById('client-email');
        const itemDescriptionInput = document.getElementById('item-description');
        const amountInput = document.getElementById('amount');
        const dueDateInput = document.getElementById('due-date');
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');

        const darkModeToggle = document.getElementById('darkModeToggle');

        let currentPdfBlob = null; // To store the generated PDF blob for download

        // --- Utility Functions ---
        function showScreen(screen) {
            introScreen.style.display = 'none';
            authScreen.style.display = 'none';
            dashboardScreen.style.display = 'none';

            screen.style.display = 'flex'; // Use flex for better centering/layout
            screen.classList.add('fade-in');
        }

        function displayMessage(element, message, type) {
            element.textContent = message;
            element.className = `message ${type}`;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 5000); // Hide after 5 seconds
        }

        function toggleAuthMode(isSignUp) {
            if (isSignUp) {
                signupForm.style.display = 'block';
                signinForm.style.display = 'none';
                authTitle.textContent = 'Sign Up';
                toggleAuthText.textContent = 'Already have an account? ';
                toggleAuthLink.textContent = 'Sign In';
            } else {
                signupForm.style.display = 'none';
                signinForm.style.display = 'block';
                authTitle.textContent = 'Sign In';
                toggleAuthText.textContent = 'Don\'t have an account? ';
                toggleAuthLink.textContent = 'Sign Up';
            }
            signupMessage.style.display = 'none';
            signinMessage.style.display = 'none';
        }

        function updateFooterYear() {
            document.getElementById('current-year').textContent = new Date().getFullYear();
        }

        // --- Supabase Auth Functions ---
        async function signUp(email, password) {
            const { data, error } = await supabase.auth.signUp({
                email: email,
                password: password,
            });

            if (error) {
                displayMessage(signupMessage, error.message, 'error');
                console.error('Sign up error:', error.message);
            } else {
                displayMessage(signupMessage, 'Check your email for the confirmation link!', 'success');
                console.log('Sign up data:', data);
            }
        }

        async function signIn(email, password) {
            const { data, error } = await supabase.auth.signInWithPassword({
                email: email,
                password: password,
            });

            if (error) {
                displayMessage(signinMessage, error.message, 'error');
                console.error('Sign in error:', error.message);
            } else {
                console.log('Sign in data:', data);
                // Auth state change listener will handle redirection
            }
        }

        async function signInWithGoogle() {
            const { data, error } = await supabase.auth.signInWithOAuth({
                provider: 'google',
            });

            if (error) {
                displayMessage(signinMessage, error.message, 'error');
                console.error('Google sign in error:', error.message);
            } else {
                console.log('Redirecting for Google sign in:', data);
            }
        }

        async function signOut() {
            const { error } = await supabase.auth.signOut();
            if (error) {
                console.error('Logout error:', error.message);
            } else {
                console.log('User logged out.');
                showScreen(introScreen); // Redirect to intro after logout
            }
        }

        // --- Dashboard Functions ---
        async function fetchUserProfile(userId) {
            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('id', userId)
                .single();

            if (error && error.code !== 'PGRST116') { // PGRST116 means no row found, which is fine for new users
                console.error('Error fetching user profile:', error.message);
                return null;
            }
            return data;
        }

        async function initializeUserProfile(userId, email) {
            const { data, error } = await supabase
                .from('users')
                .insert([
                    {
                        id: userId,
                        email: email,
                        current_plan: 'Free',
                        plan_expiry: null,
                        invoice_count_month: 0,
                        last_invoice_reset: new Date().toISOString()
                    }
                ]);

            if (error) {
                console.error('Error initializing user profile:', error.message);
                return null;
            }
            return data;
        }

        async function updateDashboard(user) {
            userEmailSpan.textContent = user.email;

            let userProfile = await fetchUserProfile(user.id);

            if (!userProfile) {
                // If user profile doesn't exist, create it
                await initializeUserProfile(user.id, user.email);
                userProfile = await fetchUserProfile(user.id); // Fetch again to get the created profile
            }

            // Reset monthly invoice count if a new month has started
            const now = new Date();
            const lastReset = new Date(userProfile.last_invoice_reset);
            if (now.getMonth() !== lastReset.getMonth() || now.getFullYear() !== lastReset.getFullYear()) {
                const { error } = await supabase
                    .from('users')
                    .update({ invoice_count_month: 0, last_invoice_reset: now.toISOString() })
                    .eq('id', user.id);
                if (error) console.error('Error resetting invoice count:', error.message);
                userProfile.invoice_count_month = 0; // Update local state for immediate display
            }

            // Highlight current plan
            freePlanCard.classList.remove('current-plan');
            proPlanCard.classList.remove('current-plan');
            advancePlanCard.classList.remove('current-plan');

            if (userProfile.current_plan === 'Free') {
                freePlanCard.classList.add('current-plan');
            } else if (userProfile.current_plan === 'Pro') {
                proPlanCard.classList.add('current-plan');
                proExpiryDateSpan.textContent = userProfile.plan_expiry ? new Date(userProfile.plan_expiry).toLocaleDateString() : 'N/A';
            } else if (userProfile.current_plan === 'Advance') {
                advancePlanCard.classList.add('current-plan');
                advanceExpiryDateSpan.textContent = userProfile.plan_expiry ? new Date(userProfile.plan_expiry).toLocaleDateString() : 'N/A';
            }

            showScreen(dashboardScreen);
        }

        async function generateAndSaveInvoice(invoiceData) {
            const user = await supabase.auth.getUser();
            if (!user.data.user) {
                displayMessage(invoiceMessage, 'You must be logged in to generate an invoice.', 'error');
                return;
            }

            const userId = user.data.user.id;
            let userProfile = await fetchUserProfile(userId);

            // Check invoice limits
            const invoiceLimit = {
                'Free': 5,
                'Pro': 50,
                'Advance': Infinity
            }[userProfile.current_plan];

            if (userProfile.invoice_count_month >= invoiceLimit) {
                displayMessage(invoiceMessage, `You have reached your monthly invoice limit (${invoiceLimit}) for the ${userProfile.current_plan} plan. Upgrade to generate more.`, 'error');
                return;
            }

            // Generate PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            const primaryColor = document.body.classList.contains('dark-mode') ? '#4299e1' : '#007bff';
            const textColor = document.body.classList.contains('dark-mode') ? '#f7fafc' : '#333';
            const lightTextColor = document.body.classList.contains('dark-mode') ? '#a0aec0' : '#666';

            doc.setFillColor(primaryColor);
            doc.rect(0, 0, doc.internal.pageSize.width, 30, 'F'); // Header background

            doc.setFontSize(28);
            doc.setTextColor(255, 255, 255); // White text
            doc.text("INVOICE", 15, 20);

            doc.setTextColor(textColor); // Reset to main text color
            doc.setFontSize(12);

            let y = 50;
            const margin = 15;

            doc.setFontSize(14);
            doc.setFont("helvetica", "bold");
            doc.text("Invoice To:", margin, y);
            y += 7;
            doc.setFont("helvetica", "normal");
            doc.text(`Name: ${invoiceData.clientName}`, margin, y);
            y += 7;
            doc.text(`Email: ${invoiceData.clientEmail}`, margin, y);
            y += 20;

            doc.setFont("helvetica", "bold");
            doc.text("Invoice Details:", margin, y);
            y += 7;
            doc.setFont("helvetica", "normal");
            doc.text(`Description: ${invoiceData.itemDescription}`, margin, y);
            y += 7;
            doc.text(`Amount: $${invoiceData.amount.toFixed(2)}`, margin, y);
            y += 7;
            doc.text(`Due Date: ${invoiceData.dueDate}`, margin, y);
            y += 20;

            doc.setFontSize(16);
            doc.setFont("helvetica", "bold");
            doc.setTextColor(primaryColor);
            doc.text(`TOTAL: $${invoiceData.amount.toFixed(2)}`, margin, y);

            doc.setFontSize(10);
            doc.setTextColor(lightTextColor);
            doc.text("Thank you for your business!", doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 20, { align: "center" });
            doc.text("Generated by AI Invoice Generator", doc.internal.pageSize.width / 2, doc.internal.pageSize.height - 15, { align: "center" });

            currentPdfBlob = doc.output('blob'); // Store the blob
            downloadPdfBtn.style.display = 'block';

            // Save invoice details to Supabase
            const { data, error } = await supabase
                .from('invoices')
                .insert([
                    {
                        user_id: userId,
                        client_name: invoiceData.clientName,
                        client_email: invoiceData.clientEmail,
                        item_description: invoiceData.itemDescription,
                        amount: invoiceData.amount,
                        due_date: invoiceData.dueDate,
                        generated_at: new Date().toISOString()
                    }
                ]);

            if (error) {
                displayMessage(invoiceMessage, `Error saving invoice: ${error.message}`, 'error');
                console.error('Error saving invoice:', error.message);
                return;
            }

            // Increment invoice count
            const { error: updateError } = await supabase
                .from('users')
                .update({ invoice_count_month: userProfile.invoice_count_month + 1 })
                .eq('id', userId);

            if (updateError) {
                console.error('Error updating invoice count:', updateError.message);
            }

            displayMessage(invoiceMessage, 'Invoice generated and saved successfully!', 'success');
            invoiceGeneratorForm.reset(); // Clear form
        }

        // --- Event Listeners ---
        getStartedBtn.addEventListener('click', () => {
            showScreen(authScreen);
            toggleAuthMode(true); // Default to Sign Up
        });

        toggleAuthLink.addEventListener('click', (e) => {
            e.preventDefault();
            const isSignUp = signupForm.style.display === 'none';
            toggleAuthMode(isSignUp);
        });

        signupForm.addEventListener('submit', (e) => {
            e.preventDefault();
            signUp(signupEmail.value, signupPassword.value);
        });

        signinForm.addEventListener('submit', (e) => {
            e.preventDefault();
            signIn(signinEmail.value, signinPassword.value);
        });

        googleSigninBtn.addEventListener('click', signInWithGoogle);

        logoutBtn.addEventListener('click', signOut);

        invoiceGeneratorForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const invoiceData = {
                clientName: clientNameInput.value,
                clientEmail: clientEmailInput.value,
                itemDescription: itemDescriptionInput.value,
                amount: parseFloat(amountInput.value),
                dueDate: dueDateInput.value
            };
            generateAndSaveInvoice(invoiceData);
        });

        downloadPdfBtn.addEventListener('click', () => {
            if (currentPdfBlob) {
                const url = URL.createObjectURL(currentPdfBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'invoice.pdf';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url); // Clean up the object URL
            }
        });

        // --- Dark Mode Toggle ---
        darkModeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-mode');
            // Store preference in localStorage
            if (document.body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
            } else {
                localStorage.setItem('theme', 'light');
            }
        });

        // Check for stored theme preference on load
        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }
        }

        // --- Supabase Auth State Listener ---
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (session) {
                console.log('User session:', session);
                await updateDashboard(session.user);
            } else {
                console.log('No active session.');
                // Only redirect to intro if not already on it (e.g., after initial load)
                if (dashboardScreen.style.display === 'flex') {
                     showScreen(introScreen);
                }
            }
        });

        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            updateFooterYear();
            applySavedTheme();

            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                await updateDashboard(session.user);
            } else {
                showScreen(introScreen);
            }
        });

        // Mock plan details for demonstration (Supabase would manage real plans)
        // For a real app, you'd fetch these from a 'plans' table in Supabase
        // and link them to user's 'current_plan' and 'plan_expiry'
        // This example assumes 'plan_expiry' is stored in the user's profile directly.
        // For now, we'll just style based on the 'current_plan' from user profile.
    </script>
</body>
</html>
