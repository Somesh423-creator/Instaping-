<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Invoice AI</title>
    <!-- The CSS is now included directly in the HTML file -->
    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #6c757d;
            --bg-light: #f8f9fa;
            --text-light: #212529;
            --bg-dark: #2c3e50;
            --text-dark: #ecf0f1;
            --card-bg-light: #ffffff;
            --card-bg-dark: #34495e;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --error-color: #dc3545;
            --font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }

        body {
            font-family: var(--font-family);
            margin: 0;
            transition: background-color 0.3s, color 0.3s;
        }

        .light-mode { background-color: var(--bg-light); color: var(--text-light); }
        .dark-mode { background-color: var(--bg-dark); color: var(--text-dark); }
        .dark-mode .card { background-color: var(--card-bg-dark); border: 1px solid var(--secondary-color); }
        .dark-mode input, .dark-mode textarea { background-color: #2c3e50; color: var(--text-dark); border: 1px solid var(--secondary-color); }
        .dark-mode input::placeholder, .dark-mode textarea::placeholder { color: #bdc3c7; }

        header {
            background: var(--card-bg-light);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 0.8rem 2rem;
            border-bottom: 1px solid var(--border-color);
        }
        .dark-mode header { background: var(--card-bg-dark); border-bottom: 1px solid var(--secondary-color); }

        nav { display: flex; justify-content: space-between; align-items: center; }
        .logo-title { font-size: 1.5rem; color: var(--primary-color); }

        main { padding: 1rem; max-width: 800px; margin: 2rem auto; }

        .card {
            background-color: var(--card-bg-light);
            border-radius: 8px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            border: 1px solid var(--border-color);
        }

        .auth-container { text-align: center; max-width: 400px; margin: auto; }
        .auth-container h2 { margin-bottom: 0.5rem; }
        .auth-container p { margin-bottom: 2rem; color: var(--secondary-color); }
        .dark-mode .auth-container p { color: #bdc3c7; }

        .divider { text-align: center; margin: 1rem 0; font-weight: bold; color: var(--secondary-color); }

        input, textarea, button {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 1rem;
            border-radius: 5px;
            border: 1px solid var(--border-color);
            font-size: 1rem;
            box-sizing: border-box;
        }
        textarea { resize: vertical; min-height: 100px; }

        .auth-button, .cta-button {
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        .auth-button.primary, .cta-button { background-color: var(--primary-color); color: white; }
        .auth-button.primary:hover, .cta-button:hover { background-color: #0056b3; }
        .auth-button.google { background-color: #db4437; color: white; }
        .auth-button.google:hover { background-color: #c23321; }
        

        .form-row { display: flex; gap: 1rem; }
        .message { text-align: center; font-weight: bold; padding: 1rem; border-radius: 5px;}
        .message.success { color: var(--success-color); background-color: rgba(40, 167, 69, 0.1); }
        .message.error { color: var(--error-color); background-color: rgba(220, 53, 69, 0.1); }

        #dark-mode-toggle { background: none; border: none; font-size: 1.5rem; cursor: pointer; }

        @media (max-width: 600px) {
            main { padding: 1rem; }
            header { padding: 0.8rem 1rem; }
            .form-row { flex-direction: column; gap: 0; }
        }
    </style>
    <!-- Supabase and jsPDF libraries -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="light-mode">

    <header>
        <nav>
            <h1 class="logo-title">Global Invoice AI</h1>
            <div>
                <button id="dark-mode-toggle" aria-label="Toggle Dark Mode">ðŸŒ“</button>
                <button id="sign-out-btn" class="auth-button" style="display: none;">Sign Out</button>
            </div>
        </nav>
    </header>

    <main>
        <!-- Authentication Section -->
        <section id="auth-section">
            <div class="auth-container">
                <h2>Get Started</h2>
                <p>Sign in to create and manage your invoices.</p>
                <div id="auth-form-container">
                    <input type="email" id="email-input" placeholder="Enter your email" required>
                    <button id="sign-in-email-btn" class="auth-button primary">Sign In with Email</button>
                    <div class="divider">or</div>
                    <button id="google-signin-btn" class="auth-button google">Sign In with Google</button>
                </div>
                <p id="auth-message" class="message"></p>
            </div>
        </section>

        <!-- Main Dashboard Section (Visible after login) -->
        <section id="dashboard-section" style="display: none;">
            <div class="dashboard-header">
                <h2 id="welcome-message">Dashboard</h2>
            </div>

            <div class="card" id="plan-details-card">
                <h3>Your Plan</h3>
                <p id="plan-info">Loading...</p>
                <p id="invoice-count-info">Invoices this month: Loading...</p>
                <button id="upgrade-plan-btn" class="cta-button" style="display: none;">ðŸš€ Upgrade to Pro</button>
            </div>

            <div class="card" id="invoice-generator-card">
                <h3>Create New Invoice</h3>
                <form id="invoice-form">
                    <input type="text" id="client-name" name="client_name" placeholder="Client Name" required>
                    <input type="email" id="client-email" name="client_email" placeholder="Client Email" required>
                    <textarea id="item-description" name="item_description" placeholder="Item Description (e.g., Web Design Services)" required></textarea>
                    <div class="form-row">
                        <input type="number" id="quantity" name="quantity" placeholder="Quantity" required min="0">
                        <input type="number" id="unit-price" name="unit_price" placeholder="Unit Price" required min="0" step="0.01">
                    </div>
                    <div class="form-row">
                        <input type="text" id="currency" name="currency" value="USD">
                        <input type="number" id="tax-rate" name="tax_rate" placeholder="Tax Rate (%)" min="0">
                    </div>
                    <label for="due-date">Due Date:</label>
                    <input type="date" id="due-date" name="due_date" required>
                    <button type="submit" id="generate-invoice-btn" class="cta-button">Generate Invoice & Download PDF</button>
                </form>
                <p id="invoice-message" class="message"></p>
            </div>
        </section>
    </main>

    <!-- The JavaScript is now included directly in the HTML file -->
    <script>
        // === CONFIGURATION (Your keys are now included) ===
        const SUPABASE_URL = 'https://gjpzbbpgqzqbmoomygjy.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdqcHpiYnBncXpxYm1vb215Z2p5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTMxMDcyMzUsImV4cCI6MjA2ODY4MzIzNX0.0EbdKvDPrHZiRWWFZkTFgV2O4l6xHc3arz0BwCmjA98';

        // === INITIALIZATION ===
        const { createClient } = supabase;
        const _supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.jsPDF = window.jspdf.jsPDF;

        // === DOM ELEMENTS ===
        const authSection = document.getElementById('auth-section');
        const dashboardSection = document.getElementById('dashboard-section');
        const signOutBtn = document.getElementById('sign-out-btn');
        const googleSignInBtn = document.getElementById('google-signin-btn');
        const signInEmailBtn = document.getElementById('sign-in-email-btn');
        const emailInput = document.getElementById('email-input');
        const authMessage = document.getElementById('auth-message');
        const invoiceForm = document.getElementById('invoice-form');
        const invoiceMessage = document.getElementById('invoice-message');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const planInfo = document.getElementById('plan-info');
        const invoiceCountInfo = document.getElementById('invoice-count-info');
        const upgradeBtn = document.getElementById('upgrade-plan-btn');
        const welcomeMessage = document.getElementById('welcome-message');

        // === AUTHENTICATION ===
        const handleGoogleSignIn = async () => {
            const { error } = await _supabase.auth.signInWithOAuth({ provider: 'google' });
            if (error) displayMessage(authMessage, `Error: ${error.message}`, 'error');
        };

        const handleEmailSignIn = async () => {
            const email = emailInput.value;
            if (!email) return displayMessage(authMessage, 'Please enter your email.', 'error');
            const { error } = await _supabase.auth.signInWithOtp({ email });
            if (error) {
                displayMessage(authMessage, `Error: ${error.message}`, 'error');
            } else {
                displayMessage(authMessage, 'Check your email for the magic sign-in link!', 'success');
                signInEmailBtn.disabled = true;
            }
        };

        const handleSignOut = async () => {
            await _supabase.auth.signOut();
            window.location.reload();
        };

        // === UI MANAGEMENT ===
        const setupUI = (user) => {
            if (user) {
                authSection.style.display = 'none';
                dashboardSection.style.display = 'block';
                signOutBtn.style.display = 'block';
                welcomeMessage.innerText = `Welcome, ${user.email.split('@')[0]}`;
                fetchAndDisplayUserData(user.id);
            } else {
                authSection.style.display = 'block';
                dashboardSection.style.display = 'none';
                signOutBtn.style.display = 'none';
            }
        };

        const displayMessage = (element, text, type) => {
            element.textContent = text;
            element.className = `message ${type}`;
            setTimeout(() => { element.textContent = ''; element.className = 'message'; }, 5000);
        };

        const toggleDarkMode = () => {
            document.body.classList.toggle('dark-mode');
            const isDarkMode = document.body.classList.contains('dark-mode');
            document.body.classList.toggle('light-mode', !isDarkMode);
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        };

        // === DATA & BUSINESS LOGIC ===
        const fetchAndDisplayUserData = async (userId) => {
            const { data, error } = await _supabase.from('users').select('*').eq('id', userId).single();

            if (error && error.code !== 'PGRST116') { // PGRST116 = row not found, ignore
                console.error('Error fetching user data:', error);
                return;
            }

            if (data) {
                const limits = { 'Free': 5, 'Pro': 50, 'Advance': Infinity };
                const limit = limits[data.current_plan] || 5;
                planInfo.innerText = `Current Plan: ${data.current_plan}`;
                invoiceCountInfo.innerText = `Invoices this month: ${data.invoice_count_month} / ${limit === Infinity ? 'Unlimited' : limit}`;
                upgradeBtn.style.display = data.current_plan === 'Free' ? 'block' : 'none';
            }
        };

        const handleInvoiceGeneration = async (e) => {
            e.preventDefault();
            const userResponse = await _supabase.auth.getUser();
            if (!userResponse.data.user) return displayMessage(invoiceMessage, 'You must be logged in.', 'error');

            const userId = userResponse.data.user.id;
            
            // Check plan limits
            const { data: userData } = await _supabase.from('users').select('current_plan, invoice_count_month').eq('id', userId).single();
            const limits = { 'Free': 5, 'Pro': 50 };
            if (userData.current_plan in limits && userData.invoice_count_month >= limits[userData.current_plan]) {
                displayMessage(invoiceMessage, 'You have reached your monthly invoice limit. Please upgrade.', 'error');
                return;
            }

            const formData = new FormData(invoiceForm);
            const invoiceData = Object.fromEntries(formData.entries());
            const totalAmount = parseFloat(invoiceData.quantity) * parseFloat(invoiceData.unit_price);
            
            const { error: insertError } = await _supabase.from('invoices').insert([{
                user_id: userId,
                client_name: invoiceData.client_name,
                client_email: invoiceData.client_email,
                item_description: invoiceData.item_description,
                amount: totalAmount,
                due_date: invoiceData.due_date,
            }]);

            if (insertError) {
                displayMessage(invoiceMessage, `Error creating invoice: ${insertError.message}`, 'error');
            } else {
                await _supabase.rpc('increment_invoice_count', { user_id_input: userId });
                displayMessage(invoiceMessage, 'Invoice created successfully! PDF is downloading.', 'success');
                fetchAndDisplayUserData(userId); // Refresh UI
                generatePDF(invoiceData, totalAmount);
                invoiceForm.reset();
            }
        };

        const generatePDF = (invoiceData, totalAmount) => {
            const doc = new jsPDF();
            doc.setFontSize(22);
            doc.text("Invoice", 105, 20, null, null, "center");
            doc.setFontSize(12);
            doc.text(`Invoice For: ${invoiceData.client_name}`, 20, 40);
            doc.text(`Client Email: ${invoiceData.client_email}`, 20, 50);
            doc.text(`Due Date: ${invoiceData.due_date}`, 20, 60);
            
            doc.setLineWidth(0.5);
            doc.line(20, 65, 190, 65);
            
            doc.text("Description", 20, 75);
            doc.text("Amount", 170, 75);
            doc.line(20, 78, 190, 78);

            doc.text(invoiceData.item_description, 20, 88, { maxWidth: 140 });
            const tax = totalAmount * (parseFloat(invoiceData.tax_rate || 0) / 100);
            const finalAmount = totalAmount + tax;
            doc.text(`${totalAmount.toFixed(2)} ${invoiceData.currency}`, 170, 88);
            
            if(tax > 0) {
              doc.text(`Tax (${invoiceData.tax_rate}%):`, 140, 100, null, null, "right");
              doc.text(`${tax.toFixed(2)}`, 170, 100);
            }
            doc.setFont(undefined, 'bold');
            doc.text(`Total:`, 140, 110, null, null, "right");
            doc.text(`${finalAmount.toFixed(2)} ${invoiceData.currency}`, 170, 110);
            
            doc.save(`Invoice-${invoiceData.client_name.replace(/\s/g, '_')}.pdf`);
        };

        // === EVENT LISTENERS & INITIAL LOAD ===
        document.addEventListener('DOMContentLoaded', () => {
            googleSignInBtn.addEventListener('click', handleGoogleSignIn);
            signInEmailBtn.addEventListener('click', handleEmailSignIn);
            signOutBtn.addEventListener('click', handleSignOut);
            invoiceForm.addEventListener('submit', handleInvoiceGeneration);
            darkModeToggle.addEventListener('click', toggleDarkMode);

            // Apply saved theme
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
                document.body.classList.remove('light-mode');
            }

            _supabase.auth.onAuthStateChange((_event, session) => {
                setupUI(session ? session.user : null);
            });
        });

    </script>
</body>
</html>